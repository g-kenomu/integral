<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç©åˆ†ãƒã‚¹ã‚¿ãƒ¼ - ç©¶æ¥µã®è¨ˆç®—æ¼”ç¿’ã‚¢ãƒ—ãƒª</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', -apple-system, sans-serif; -webkit-font-smoothing: antialiased; }
        .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        
        .progress-bar { transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .stamp-anim { animation: stamp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stamp {
            0% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* é›£å•ãƒ»è¶…é›£å•ç”¨ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
        .bg-super-hard { background-color: #0f0202; }
        .text-super-hard { color: #fecaca; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-500">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Math Engine & Generators ---
        class Seeder {
            constructor(seedStr) {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < seedStr.length; i++) {
                    h = Math.imul(h ^ seedStr.charCodeAt(i), 16777619);
                }
                this.seed = h;
            }
            random() {
                let t = this.seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        const getRandomInt = (min, max, rng = Math.random) => Math.floor(rng() * (max - min + 1)) + min;

        // --- ç„¡é™æ¼”ç¿’ç”¨ (æ•°III æ¨™æº–ãƒ¬ãƒ™ãƒ«) ---
        const normalGens = [
            (rng) => { 
                const a = getRandomInt(2, 5, rng);
                const n = getRandomInt(3, 5, rng);
                return { type: "åŸºæœ¬", latex: `\\int (${a}x + 1)^{${n}} \\, dx`, hint: `\\((ax+b)^n\\)ã®å½¢ã€‚ä¿‚æ•° \\(\\frac{1}{a}\\) ã‚’å¿˜ã‚Œãšã«ãªã€‚`, answer: `\\frac{1}{${a*(n+1)}} (${a}x + 1)^{${n+1}} + C`, xp: 20 };
            },
            (rng) => { 
                const a = getRandomInt(2, 4, rng);
                return { type: "ä¸‰è§’é–¢æ•°", latex: `\\int \\sin(${a}x) \\, dx`, hint: `è§’åº¦ã®ä¿‚æ•°ãŒå‡ºã‚‹ã€‚sinã‚’ç©åˆ†ã™ã‚‹ã¨è² ã®ç¬¦å·ãŒã¤ããã€‚`, answer: `-\\frac{1}{${a}} \\cos(${a}x) + C`, xp: 30 };
            },
            (rng) => { 
                const a = getRandomInt(3, 5, rng);
                const b = getRandomInt(1, 2, rng);
                const sum = a + b;
                const diff = a - b;
                return { type: "ç©å’Œã®å…¬å¼", latex: `\\int \\sin ${a}x \\cos ${b}x \\, dx`, hint: `ç©å’Œã®å…¬å¼ã§å’Œã®å½¢ã«ç›´ã™ã€‚`, answer: `-\\frac{1}{2} \\left( \\frac{\\cos ${sum}x}{${sum}} + \\frac{\\cos ${diff}x}{${diff}} \\right) + C`, xp: 50 };
            },
            (rng) => { 
                return { type: "éƒ¨åˆ†ç©åˆ†", latex: `\\int x e^x \\, dx`, hint: `\\(x\\)ã‚’å¾®åˆ†å´ã«ã€\\(e^x\\)ã‚’ç©åˆ†å´ã«ã€‚`, answer: `(x-1)e^x + C`, xp: 40 };
            },
            (rng) => { 
                const a = getRandomInt(1, 3, rng);
                return { type: "ç½®æ›ç©åˆ†", latex: `\\int x \\sqrt{x^2+${a}} \\, dx`, hint: `ä¸­èº« \\(x^2+${a}\\) ã®å¾®åˆ† \\(2x\\) ãŒå¤–ã«ã‚ã‚‹ã“ã¨ã«æ³¨ç›®ã€‚`, answer: `\\frac{1}{3}(x^2+${a})^{\\frac{3}{2}} + C`, xp: 45 };
            }
        ];

        // --- é›£å•ç”¨ (æ—§å¸å¤§ æ¨™æº–ã€œé›£ãƒ¬ãƒ™ãƒ«) ---
        const hardGens = [
            (rng) => ({ type: "â˜…é›£å•(2å€è§’)", latex: `\\int \\frac{1}{1 + \\cos x} \\, dx`, hint: `åŠè§’ã®å…¬å¼ã®é€† \\(1+\\cos x = 2\\cos^2 \\frac{x}{2}\\) ã‚’ä½¿ã†ã®ãŒæœ€é€Ÿã€‚`, answer: `\\tan \\frac{x}{2} + C`, xp: 100 }),
            (rng) => ({ type: "â˜…é›£å•(tan)", latex: `\\int \\tan^3 x \\, dx`, hint: `\\(\\tan^2 x = \\frac{1}{\\cos^2 x} - 1\\) ã‚’ä½¿ã£ã¦æ¬¡æ•°ã‚’ä¸‹ã’ã‚‹ã€‚`, answer: `\\frac{1}{2} \\tan^2 x + \\log |\\cos x| + C`, xp: 110 }),
            (rng) => ({ type: "â˜…é›£å•(å¯¾æ•°)", latex: `\\int (\\log x)^2 \\, dx`, hint: `éƒ¨åˆ†ç©åˆ†ã‚’2å›è¡Œã†ã€‚æ ¹æ°—å‹è² ã€‚`, answer: `x(\\log x)^2 - 2x\\log x + 2x + C`, xp: 120 }),
            (rng) => {
                const a = getRandomInt(2, 4, rng);
                return { type: "â˜…é›£å•(æŒ‡æ•°)", latex: `\\int \\frac{1}{e^x + ${a}} \\, dx`, hint: `åˆ†æ¯åˆ†å­ã« \\(e^{-x}\\) ã‚’æ›ã‘ã‚‹ã‹ã€éƒ¨åˆ†åˆ†æ•°åˆ†è§£ã®ã‚ˆã†ãªå¤‰å½¢ã‚’è¡Œã†ã€‚`, answer: `\\frac{1}{${a}} (x - \\log(e^x + ${a})) + C`, xp: 130 };
            },
            (rng) => ({ type: "â˜…é›£å•(ç½®æ›)", latex: `\\int \\frac{1}{x \\log x} \\, dx`, hint: `\\(\\log x = t\\) ã¨ç½®æ›ã™ã‚‹ã¨ã€\\(\\frac{1}{x}dx = dt\\) ã¨ãªã‚‹ã€‚`, answer: `\\log |\\log x| + C`, xp: 90 }),
            (rng) => { // åˆ†æ•°é–¢æ•° 1/(x^3+1)
                const a = getRandomInt(1, 2, rng); // a=1 or 2
                const a3 = a*a*a;
                const a2 = a*a;
                return {
                    type: "â˜…é›£å•(åˆ†æ•°)",
                    latex: `\\int \\frac{1}{x^3 + ${a3}} \\, dx`,
                    hint: `å› æ•°åˆ†è§£ \\(x^3+${a}^3 = (x+${a})(x^2-${a}x+${a2})\\) ã‚’è¡Œã„ã€éƒ¨åˆ†åˆ†æ•°åˆ†è§£ã™ã‚‹ã€‚è¨ˆç®—é‡ãŒéå¸¸ã«å¤šã„ã€‚`,
                    answer: `\\frac{1}{${3*a2}} \\log|x+${a}| - \\frac{1}{${6*a2}} \\log(x^2-${a}x+${a2}) + \\frac{1}{${a2}\\sqrt{3}} \\tan^{-1}\\frac{2x-${a}}{\\sqrt{3}${a}} + C`,
                    xp: 200
                };
            },
            (rng) => ({ // x/cos^2 x
                type: "â˜…é›£å•(éƒ¨åˆ†)",
                latex: `\\int \\frac{x}{\\cos^2 x} \\, dx`,
                hint: `\\( (\\tan x)' = \\frac{1}{\\cos^2 x} \\) ã«æ³¨ç›®ã—ã¦éƒ¨åˆ†ç©åˆ†ã‚’è¡Œã†ã€‚`,
                answer: `x \\tan x + \\log |\\cos x| + C`,
                xp: 130
            }),
            (rng) => ({ // e^sqrt(x)
                type: "â˜…é›£å•(ç½®æ›)",
                latex: `\\int e^{\\sqrt{x}} \\, dx`,
                hint: `\\(\\sqrt{x} = t\\) ã¨ç½®æ›ã™ã‚‹ã€‚\\(x=t^2, dx=2t dt\\) ã¨ãªã‚Š \\(\\int 2t e^t dt\\) ã«å¸°ç€ã€‚`,
                answer: `2e^{\\sqrt{x}}(\\sqrt{x}-1) + C`,
                xp: 130
            })
        ];

        // --- è¶…é›£å•ç”¨ (æ±å¤§ãƒ»äº¬å¤§ãƒ»åŒ»å­¦éƒ¨ãƒ¬ãƒ™ãƒ«) ---
        const superHardGens = [
            (rng) => ({ 
                type: "ğŸ”¥ğŸ”¥è¶…é›£å•", 
                latex: `\\int \\frac{1}{1+x^4} \\, dx`, 
                hint: `å› æ•°åˆ†è§£ã®é›£å•ã€‚\\(x^4+1 = (x^2+1)^2 - 2x^2 = (x^2+\\sqrt{2}x+1)(x^2-\\sqrt{2}x+1)\\) ã¨å¤‰å½¢ã—ã€éƒ¨åˆ†åˆ†æ•°åˆ†è§£ã‚’è¡Œã†ã€‚è¨ˆç®—åœ°ç„ã€‚`, 
                answer: `\\frac{1}{2\\sqrt{2}} \\left( \\frac{1}{2} \\log \\frac{x^2+\\sqrt{2}x+1}{x^2-\\sqrt{2}x+1} + \\tan^{-1}(\\sqrt{2}x+1) + \\tan^{-1}(\\sqrt{2}x-1) \\right) + C`, 
                xp: 500 
            }),
            (rng) => ({ 
                type: "ğŸ”¥ğŸ”¥è¶…é›£å•", 
                latex: `\\int \\sqrt{\\tan x} \\, dx`, 
                hint: `\\(\\sqrt{\\tan x} = t\\) ã¨ç½®æ›ã™ã‚‹ã€‚\\(x = \\arctan(t^2)\\) ã‚ˆã‚Š \\(dx = \\frac{2t}{1+t^4} dt\\)ã€‚\\(\\int \\frac{2t^2}{1+t^4} dt\\) ã«å¸°ç€ã•ã›ã€åˆ†æ¯ã‚’å› æ•°åˆ†è§£ã™ã‚‹ã€‚`, 
                answer: `\\frac{1}{\\sqrt{2}} \\left( \\tan^{-1}\\frac{\\sqrt{2}\\sqrt{\\tan x}}{\\tan x - 1} + \\frac{1}{2} \\log \\left| \\frac{\\tan x - \\sqrt{2}\\sqrt{\\tan x} + 1}{\\tan x + \\sqrt{2}\\sqrt{\\tan x} + 1} \\right| \\right) + C`, 
                xp: 600 
            }),
            (rng) => ({ 
                type: "ğŸ”¥ğŸ”¥è¶…é›£å•", 
                latex: `\\int \\frac{\\log x}{(1+x)^2} \\, dx`, 
                hint: `\\((1+x)^{-2}\\) ã‚’ç©åˆ†å´ã€\\(\\log x\\) ã‚’å¾®åˆ†å´ã«ã—ã¦éƒ¨åˆ†ç©åˆ†ã‚’è¡Œã†ã€‚ãã®å¾Œã€éƒ¨åˆ†åˆ†æ•°åˆ†è§£ãŒå¿…è¦ã«ãªã‚‹ã€‚`, 
                answer: `-\\frac{\\log x}{1+x} + \\log|x| - \\log|1+x| + C`, 
                xp: 300 
            }),
            (rng) => ({ 
                type: "ğŸ”¥ğŸ”¥è¶…é›£å•", 
                latex: `\\int e^x \\sin 2x \\, dx`, 
                hint: `éƒ¨åˆ†ç©åˆ†ã‚’2å›ç¹°ã‚Šè¿”ã—ã¦ã€å…ƒã®å½¢ï¼ˆ\\(I\\)ï¼‰ãŒå‡ºãŸã‚‰ç§»é …ã—ã¦è§£ãå¾ªç’°å‹ã€‚ä¿‚æ•°ã®å‡¦ç†ã‚’é–“é•ãˆã‚„ã™ã„ã€‚`, 
                answer: `\\frac{e^x}{5} (\\sin 2x - 2\\cos 2x) + C`, 
                xp: 250 
            }),
            (rng) => ({ 
                type: "ğŸ”¥ğŸ”¥è¶…é›£å•", 
                latex: `\\int \\frac{1}{\\sin^3 x} \\, dx`, 
                hint: `\\(\\sin x = \\frac{2t}{1+t^2}\\) (\\(t=\\tan(x/2)\\)) ã®ç½®æ›ã€ã¾ãŸã¯ \\(\\frac{\\sin x}{\\sin^4 x}\\) ã¨ã—ã¦ \\(\\cos x = t\\) ç½®æ›ã‹ã‚‰ã®éƒ¨åˆ†åˆ†æ•°åˆ†è§£ã€‚`, 
                answer: `-\\frac{\\cos x}{2\\sin^2 x} + \\frac{1}{2} \\log \\left| \\tan \\frac{x}{2} \\right| + C`, 
                xp: 350 
            }),
            (rng) => { // sqrt(x^2 + k)
                const k = getRandomInt(1, 3, rng);
                const k2 = k*k;
                return {
                    type: "ğŸ”¥ğŸ”¥è¶…é›£å•",
                    latex: `\\int \\sqrt{x^2 + ${k2}} \\, dx`,
                    hint: `\\(x + \\sqrt{x^2+${k2}} = t\\) ã¨ç½®æ›ã™ã‚‹ã‹ã€éƒ¨åˆ†ç©åˆ† \\(1 \\cdot \\sqrt{\\dots}\\) ã§è‡ªåˆ†è‡ªèº«ãŒå‡ºç¾ã™ã‚‹å½¢ã«æŒã¡è¾¼ã‚€ã€‚`,
                    answer: `\\frac{1}{2} \\left( x\\sqrt{x^2+${k2}} + ${k2}\\log(x+\\sqrt{x^2+${k2}}) \\right) + C`,
                    xp: 400
                };
            },
            (rng) => ({ // 1/(sin x + cos x)
                type: "ğŸ”¥ğŸ”¥è¶…é›£å•",
                latex: `\\int \\frac{1}{\\sin x + \\cos x} \\, dx`,
                hint: `ä¸‰è§’é–¢æ•°ã®åˆæˆã‚’è¡Œã„ \\(\\sqrt{2}\\sin(x+\\frac{\\pi}{4})\\) ã®å½¢ã«ã™ã‚‹ã€‚ãã®å¾Œ \\(\\int \\frac{1}{\\sin t} dt = \\frac{1}{2} \\log \\frac{1-\\cos t}{1+\\cos t}\\) ç­‰ã‚’åˆ©ç”¨ã€‚`,
                answer: `\\frac{1}{\\sqrt{2}} \\log \\left| \\tan \\left( \\frac{x}{2} + \\frac{\\pi}{8} \\right) \\right| + C`,
                xp: 450
            }),
            (rng) => { // e^ax cos bx
                const a = getRandomInt(1, 2, rng);
                const b = getRandomInt(1, 3, rng);
                return {
                    type: "ğŸ”¥ğŸ”¥è¶…é›£å•",
                    latex: `\\int e^{${a}x} \\cos ${b}x \\, dx`,
                    hint: `éƒ¨åˆ†ç©åˆ†ã‚’2å›è¡Œã„ã€å…ƒã®ç©åˆ† \\(I\\) ãŒå†ã³ç¾ã‚ŒãŸã‚‰ç§»é …ã—ã¦è§£ãæ–¹ç¨‹å¼å‹ã€‚`,
                    answer: `\\frac{e^{${a}x}}{${a*a+b*b}} (${a}\\cos ${b}x + ${b}\\sin ${b}x) + C`,
                    xp: 350
                };
            }
        ];

        // --- Sound Effects (Web Audio API) ---
        const playSound = (freq, type = 'sine', duration = 0.1) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
        };

        // --- Components ---
        const MathDisplay = ({ latex }) => {
            const ref = useRef();
            useEffect(() => { if (window.katex) window.katex.render(latex, ref.current, { displayMode: true }); }, [latex]);
            return <div ref={ref}></div>;
        };

        const ParsedText = ({ text }) => {
            const parts = text.split(/\\\((.*?)\\\)/g);
            return <span>{parts.map((p, i) => i % 2 === 1 ? <MathDisplay key={i} latex={p} /> : <span key={i}>{p}</span>)}</span>;
        };

        function App() {
            const [problem, setProblem] = useState(null);
            const [showHint, setShowHint] = useState(false);
            const [showAnswer, setShowAnswer] = useState(false);
            const [mode, setMode] = useState('daily');
            const [solved, setSolved] = useState(false);
            const [user, setUser] = useState({ level: 1, xp: 0, total: 0, history: {}, streak: 0 });

            useEffect(() => {
                const saved = localStorage.getItem('integral_master_ultimate');
                if (saved) setUser(JSON.parse(saved));
                loadDaily();
            }, []);

            useEffect(() => {
                localStorage.setItem('integral_master_ultimate', JSON.stringify(user));
                if (window.lucide) window.lucide.createIcons();
            }, [user, mode]);

            const loadDaily = () => {
                setMode('daily'); setSolved(false); setShowHint(false); setShowAnswer(false);
                const s = new Seeder(new Date().toISOString().slice(0, 10));
                // ä»Šæ—¥ã®å•é¡Œã¯ã€Œè¶…é›£å•ã€ã‹ã‚‰é¸å‡º
                setProblem(superHardGens[Math.floor(s.random() * superHardGens.length)](() => s.random()));
            };

            const loadRandom = () => {
                setMode('random'); setSolved(false); setShowHint(false); setShowAnswer(false);
                // ç„¡é™æ¼”ç¿’ã¯ã€Œæ¨™æº–ã€ã‹ã‚‰é¸å‡º
                setProblem(normalGens[Math.floor(Math.random() * normalGens.length)](Math.random));
            };

            const loadHard = () => {
                setMode('hard'); setSolved(false); setShowHint(false); setShowAnswer(false);
                // é›£å•ãƒ¢ãƒ¼ãƒ‰ã¯ã€Œé›£å•ã€ã¨ã€Œè¶…é›£å•ã€ã‚’ãƒŸãƒƒã‚¯ã‚¹
                const pool = [...hardGens, ...superHardGens];
                setProblem(pool[Math.floor(Math.random() * pool.length)](Math.random));
            };

            const onSolve = () => {
                if (solved) return;
                playSound(523.25, 'triangle', 0.2);
                setTimeout(() => playSound(659.25, 'triangle', 0.2), 100);
                
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                
                const today = new Date().toISOString().slice(0, 10);
                let newXp = user.xp + problem.xp;
                let newLevel = user.level;
                const nextLevelXp = user.level * 100;

                if (newXp >= nextLevelXp) {
                    newLevel += 1;
                    newXp -= nextLevelXp;
                    playSound(880, 'sine', 0.5);
                }

                const newHistory = { ...user.history, [today]: true };
                setUser({ ...user, level: newLevel, xp: newXp, total: user.total + 1, history: newHistory });
                setSolved(true);
            };

            const isHard = mode === 'hard' || mode === 'daily'; // Dailyã‚‚ãƒãƒ¼ãƒ‰ãªè¦‹ãŸç›®ã«
            const progress = (user.xp / (user.level * 100)) * 100;

            if (!problem) return null;

            return (
                <div className={`min-h-screen pb-20 transition-colors duration-500 ${isHard ? 'bg-super-hard text-super-hard' : 'bg-slate-50 text-slate-900'}`}>
                    
                    {/* Header */}
                    <header className={`sticky top-0 z-30 border-b backdrop-blur-md ${isHard ? 'bg-black/50 border-red-900/30' : 'bg-white/80 border-slate-200'}`}>
                        <div className="max-w-md mx-auto p-4">
                            <div className="flex justify-between items-end mb-2">
                                <div className="flex items-center gap-2">
                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-black text-white ${isHard ? 'bg-red-800' : 'bg-indigo-600'}`}>
                                        {user.level}
                                    </div>
                                    <span className="text-xs font-bold uppercase tracking-widest opacity-60">Level</span>
                                </div>
                                <span className="text-[10px] font-mono opacity-50">{user.xp} / {user.level * 100} XP</span>
                            </div>
                            <div className="w-full h-1.5 bg-slate-200/20 rounded-full overflow-hidden">
                                <div className={`h-full progress-bar ${isHard ? 'bg-red-600' : 'bg-indigo-500'}`} style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 mt-4 space-y-6">
                        
                        {/* Mode Select */}
                        <div className={`flex p-1 rounded-2xl ${isHard ? 'bg-slate-900 border border-red-900/30' : 'bg-slate-200'}`}>
                            <button onClick={loadDaily} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'daily' ? 'bg-red-900 text-white shadow-lg' : (isHard ? 'text-slate-500' : 'text-slate-500')}`}>ä»Šæ—¥ã®å•é¡Œ</button>
                            <button onClick={loadRandom} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'random' ? 'bg-white text-indigo-600 shadow-lg' : 'text-slate-500'}`}>ç„¡é™æ¼”ç¿’</button>
                            <button onClick={loadHard} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'hard' ? 'bg-red-800 text-white shadow-lg' : 'text-slate-500'}`}>é›£å•ãƒ¢ãƒ¼ãƒ‰</button>
                        </div>

                        {/* Problem Card */}
                        <div className={`rounded-[2.5rem] shadow-2xl border p-8 relative flex flex-col items-center min-h-[400px] justify-center transition-all ${isHard ? 'bg-slate-900 border-red-900/50 shadow-red-900/20' : 'bg-white border-slate-200'}`}>
                            
                            <div className="absolute top-6 left-6">
                                <span className={`text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest ${isHard ? 'bg-red-900/50 text-red-400' : 'bg-slate-100 text-slate-500'}`}>
                                    {problem.type} â€¢ +{problem.xp} XP
                                </span>
                            </div>

                            <div className="w-full overflow-x-auto py-10">
                                <MathDisplay latex={problem.latex} />
                            </div>

                            {showHint && (
                                <div className={`w-full p-4 rounded-2xl mb-6 text-sm animate-in slide-in-from-top-4 ${isHard ? 'bg-red-950 border border-red-900/50 text-red-200' : 'bg-yellow-50 text-yellow-900 border border-yellow-100'}`}>
                                    <div className="flex gap-2 mb-1">
                                        <i data-lucide="lightbulb" className="w-4 h-4"></i>
                                        <span className="font-bold uppercase text-[10px]">Hint</span>
                                    </div>
                                    <ParsedText text={problem.hint} />
                                </div>
                            )}

                            {showAnswer && (
                                <div className={`w-full p-6 rounded-2xl mb-8 border animate-in zoom-in-95 ${isHard ? 'bg-black border-red-900/50' : 'bg-indigo-50 border-indigo-100'}`}>
                                    <p className="text-[10px] font-bold opacity-50 uppercase text-center mb-4 tracking-widest">è§£ç­”</p>
                                    <MathDisplay latex={problem.answer} />
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-3 w-full">
                                <button onClick={() => { setShowHint(!showHint); playSound(440, 'sine', 0.05); }} className={`p-4 rounded-2xl text-xs font-bold transition-all ${isHard ? 'bg-slate-800 text-red-400 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                    ãƒ’ãƒ³ãƒˆ
                                </button>
                                <button onClick={() => { setShowAnswer(!showAnswer); playSound(523, 'sine', 0.05); }} className={`p-4 rounded-2xl text-xs font-bold transition-all ${showAnswer ? (isHard ? 'bg-red-900' : 'bg-slate-800') : (isHard ? 'bg-red-600' : 'bg-indigo-600')} text-white shadow-lg`}>
                                    {showAnswer ? 'é–‰ã˜ã‚‹' : 'ç­”ãˆã‚’è¦‹ã‚‹'}
                                </button>
                            </div>

                            {showAnswer && !solved && (
                                <button onClick={onSolve} className={`w-full mt-4 p-5 rounded-2xl font-black text-lg shadow-xl animate-bounce transition-all ${isHard ? 'bg-gradient-to-r from-red-700 to-red-600 text-white shadow-red-900/50' : 'bg-emerald-500 text-white'}`}>
                                    å®Œç­”ã—ãŸï¼
                                </button>
                            )}

                            {solved && (mode !== 'daily') && (
                                <button onClick={mode === 'hard' ? loadHard : loadRandom} className="w-full mt-4 p-5 bg-slate-800 text-white rounded-2xl font-bold">
                                    æ¬¡ã®å•é¡Œã¸
                                </button>
                            )}
                        </div>

                        {/* Stamp Collection */}
                        <div className={`p-6 rounded-3xl border ${isHard ? 'bg-slate-900 border-red-900/30' : 'bg-white border-slate-200'}`}>
                            <h2 className="font-bold text-sm mb-4 flex items-center gap-2">
                                <i data-lucide="check-circle" className={`w-4 h-4 ${isHard ? 'text-red-500' : 'text-emerald-500'}`}></i> ä»Šé€±ã®è¨˜éŒ²
                            </h2>
                            <div className="flex justify-between">
                                {[...Array(7)].map((_, i) => {
                                    const date = new Date();
                                    date.setDate(date.getDate() - (6 - i));
                                    const dStr = date.toISOString().slice(0, 10);
                                    const isDone = user.history[dStr];
                                    return (
                                        <div key={i} className="flex flex-col items-center gap-1">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${isDone ? (isHard ? 'bg-red-600 border-red-500 text-white stamp-anim' : 'bg-emerald-500 border-emerald-400 text-white stamp-anim') : 'bg-transparent border-slate-200/20'}`}>
                                                {isDone ? <i data-lucide="check" className="w-5 h-5"></i> : <span className="text-[10px] opacity-20">{date.getDate()}</span>}
                                            </div>
                                            <span className="text-[8px] font-bold opacity-30">{(['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'])[date.getDay()]}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                    </main>

                    <footer className="mt-8 text-center px-8 text-[10px] leading-relaxed opacity-50">
                        <p>Â© 2026 Integral Master v5.0 - Ultimate Edition</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 200);
    </script>
</body>
</html>
