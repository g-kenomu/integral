<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>積分マスター - 究極の計算演習アプリ</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', -apple-system, sans-serif; -webkit-font-smoothing: antialiased; }
        .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        
        .progress-bar { transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .stamp-anim { animation: stamp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stamp {
            0% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* 難問・超難問用のテーマカラー */
        .bg-super-hard { background-color: #0f0202; }
        .text-super-hard { color: #fecaca; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-500">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Math Engine & Generators ---
        class Seeder {
            constructor(seedStr) {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < seedStr.length; i++) {
                    h = Math.imul(h ^ seedStr.charCodeAt(i), 16777619);
                }
                this.seed = h;
            }
            random() {
                let t = this.seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        const getRandomInt = (min, max, rng = Math.random) => Math.floor(rng() * (max - min + 1)) + min;

        // --- 無限演習用 (数III 標準レベル) ---
        const normalGens = [
            (rng) => { // 基本合成
                const a = getRandomInt(2, 5, rng);
                const n = getRandomInt(3, 5, rng);
                return { type: "基本", latex: `\\int (${a}x + 1)^{${n}} \\, dx`, hint: `\\((ax+b)^n\\)の形。係数 \\(\\frac{1}{a}\\) を忘れずにな。`, answer: `\\frac{1}{${a*(n+1)}} (${a}x + 1)^{${n+1}} + C`, xp: 20 };
            },
            (rng) => { // 三角関数
                const a = getRandomInt(2, 4, rng);
                return { type: "三角関数", latex: `\\int \\sin(${a}x) \\, dx`, hint: `角度の係数が出る。sinを積分すると負の符号がつくぞ。`, answer: `-\\frac{1}{${a}} \\cos(${a}x) + C`, xp: 30 };
            },
            (rng) => { // 積和公式
                const a = getRandomInt(3, 5, rng);
                const b = getRandomInt(1, 2, rng);
                const sum = a + b;
                const diff = a - b;
                return { type: "積和の公式", latex: `\\int \\sin ${a}x \\cos ${b}x \\, dx`, hint: `積和の公式で和の形に直す。`, answer: `-\\frac{1}{2} \\left( \\frac{\\cos ${sum}x}{${sum}} + \\frac{\\cos ${diff}x}{${diff}} \\right) + C`, xp: 50 };
            },
            (rng) => { // 部分積分 (x e^x)
                return { type: "部分積分", latex: `\\int x e^x \\, dx`, hint: `\\(x\\)を微分側に、\\(e^x\\)を積分側に。`, answer: `(x-1)e^x + C`, xp: 40 };
            },
            (rng) => { // 置換積分 (根号)
                const a = getRandomInt(1, 3, rng);
                return { type: "置換積分", latex: `\\int x \\sqrt{x^2+${a}} \\, dx`, hint: `中身 \\(x^2+${a}\\) の微分 \\(2x\\) が外にあることに注目。`, answer: `\\frac{1}{3}(x^2+${a})^{\\frac{3}{2}} + C`, xp: 45 };
            }
        ];

        // --- 難問用 (旧帝大 標準〜難レベル) ---
        const hardGens = [
            (rng) => ({ type: "★難問(2倍角)", latex: `\\int \\frac{1}{1 + \\cos x} \\, dx`, hint: `半角の公式の逆 \\(1+\\cos x = 2\\cos^2 \\frac{x}{2}\\) を使うのが最速。`, answer: `\\tan \\frac{x}{2} + C`, xp: 100 }),
            (rng) => ({ type: "★難問(tan)", latex: `\\int \\tan^3 x \\, dx`, hint: `\\(\\tan^2 x = \\frac{1}{\\cos^2 x} - 1\\) を使って次数を下げる。`, answer: `\\frac{1}{2} \\tan^2 x + \\log |\\cos x| + C`, xp: 110 }),
            (rng) => ({ type: "★難問(対数)", latex: `\\int (\\log x)^2 \\, dx`, hint: `部分積分を2回行う。根気勝負。`, answer: `x(\\log x)^2 - 2x\\log x + 2x + C`, xp: 120 }),
            (rng) => {
                const a = getRandomInt(2, 4, rng);
                return { type: "★難問(指数)", latex: `\\int \\frac{1}{e^x + ${a}} \\, dx`, hint: `分母分子に \\(e^{-x}\\) を掛けるか、部分分数分解のような変形を行う。`, answer: `\\frac{1}{${a}} (x - \\log(e^x + ${a})) + C`, xp: 130 };
            },
            (rng) => ({ type: "★難問(置換)", latex: `\\int \\frac{1}{x \\log x} \\, dx`, hint: `\\(\\log x = t\\) と置換すると、\\(\\frac{1}{x}dx = dt\\) となる。`, answer: `\\log |\\log x| + C`, xp: 90 })
        ];

        // --- 超難問用 (東大・京大・医学部レベル) ---
        const superHardGens = [
            (rng) => ({ 
                type: "🔥🔥超難問", 
                latex: `\\int \\frac{1}{1+x^4} \\, dx`, 
                hint: `因数分解の難問。\\(x^4+1 = (x^2+1)^2 - 2x^2 = (x^2+\\sqrt{2}x+1)(x^2-\\sqrt{2}x+1)\\) と変形し、部分分数分解を行う。計算地獄。`, 
                answer: `\\frac{1}{2\\sqrt{2}} \\left( \\frac{1}{2} \\log \\frac{x^2+\\sqrt{2}x+1}{x^2-\\sqrt{2}x+1} + \\tan^{-1}(\\sqrt{2}x+1) + \\tan^{-1}(\\sqrt{2}x-1) \\right) + C`, 
                xp: 500 
            }),
            (rng) => ({ 
                type: "🔥🔥超難問", 
                latex: `\\int \\sqrt{\\tan x} \\, dx`, 
                hint: `\\(\\sqrt{\\tan x} = t\\) と置換する。\\(x = \\arctan(t^2)\\) より \\(dx = \\frac{2t}{1+t^4} dt\\)。\\(\\int \\frac{2t^2}{1+t^4} dt\\) に帰着させ、分母を因数分解する。`, 
                answer: `\\frac{1}{\\sqrt{2}} \\left( \\tan^{-1}\\frac{\\sqrt{2}\\sqrt{\\tan x}}{\\tan x - 1} + \\frac{1}{2} \\log \\left| \\frac{\\tan x - \\sqrt{2}\\sqrt{\\tan x} + 1}{\\tan x + \\sqrt{2}\\sqrt{\\tan x} + 1} \\right| \\right) + C`, 
                xp: 600 
            }),
            (rng) => ({ 
                type: "🔥🔥超難問", 
                latex: `\\int \\frac{\\log x}{(1+x)^2} \\, dx`, 
                hint: `\\((1+x)^{-2}\\) を積分側、\\(\\log x\\) を微分側にして部分積分を行う。その後、部分分数分解が必要になる。`, 
                answer: `-\\frac{\\log x}{1+x} + \\log|x| - \\log|1+x| + C`, 
                xp: 300 
            }),
            (rng) => ({ 
                type: "🔥🔥超難問", 
                latex: `\\int e^x \\sin 2x \\, dx`, 
                hint: `部分積分を2回繰り返して、元の形（\\(I\\)）が出たら移項して解く循環型。係数の処理を間違えやすい。`, 
                answer: `\\frac{e^x}{5} (\\sin 2x - 2\\cos 2x) + C`, 
                xp: 250 
            }),
            (rng) => ({ 
                type: "🔥🔥超難問", 
                latex: `\\int \\frac{1}{\\sin^3 x} \\, dx`, 
                hint: `\\(\\sin x = \\frac{2t}{1+t^2}\\) (\\(t=\\tan(x/2)\\)) の置換、または \\(\\frac{\\sin x}{\\sin^4 x}\\) として \\(\\cos x = t\\) 置換からの部分分数分解。`, 
                answer: `-\\frac{\\cos x}{2\\sin^2 x} + \\frac{1}{2} \\log \\left| \\tan \\frac{x}{2} \\right| + C`, 
                xp: 350 
            })
        ];

        // --- Sound Effects (Web Audio API) ---
        const playSound = (freq, type = 'sine', duration = 0.1) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
        };

        // --- Components ---
        const MathDisplay = ({ latex }) => {
            const ref = useRef();
            useEffect(() => { if (window.katex) window.katex.render(latex, ref.current, { displayMode: true }); }, [latex]);
            return <div ref={ref}></div>;
        };

        const ParsedText = ({ text }) => {
            const parts = text.split(/\\\((.*?)\\\)/g);
            return <span>{parts.map((p, i) => i % 2 === 1 ? <MathDisplay key={i} latex={p} /> : <span key={i}>{p}</span>)}</span>;
        };

        function App() {
            const [problem, setProblem] = useState(null);
            const [showHint, setShowHint] = useState(false);
            const [showAnswer, setShowAnswer] = useState(false);
            const [mode, setMode] = useState('daily');
            const [solved, setSolved] = useState(false);
            const [user, setUser] = useState({ level: 1, xp: 0, total: 0, history: {}, streak: 0 });

            useEffect(() => {
                const saved = localStorage.getItem('integral_master_ultimate');
                if (saved) setUser(JSON.parse(saved));
                loadDaily();
            }, []);

            useEffect(() => {
                localStorage.setItem('integral_master_ultimate', JSON.stringify(user));
                if (window.lucide) window.lucide.createIcons();
            }, [user, mode]);

            const loadDaily = () => {
                setMode('daily'); setSolved(false); setShowHint(false); setShowAnswer(false);
                const s = new Seeder(new Date().toISOString().slice(0, 10));
                // 今日の問題は「超難問」から選出
                setProblem(superHardGens[Math.floor(s.random() * superHardGens.length)](() => s.random()));
            };

            const loadRandom = () => {
                setMode('random'); setSolved(false); setShowHint(false); setShowAnswer(false);
                // 無限演習は「標準」から選出
                setProblem(normalGens[Math.floor(Math.random() * normalGens.length)](Math.random));
            };

            const loadHard = () => {
                setMode('hard'); setSolved(false); setShowHint(false); setShowAnswer(false);
                // 難問モードは「難問」と「超難問」をミックス
                const pool = [...hardGens, ...superHardGens];
                setProblem(pool[Math.floor(Math.random() * pool.length)](Math.random));
            };

            const onSolve = () => {
                if (solved) return;
                playSound(523.25, 'triangle', 0.2);
                setTimeout(() => playSound(659.25, 'triangle', 0.2), 100);
                
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                
                const today = new Date().toISOString().slice(0, 10);
                let newXp = user.xp + problem.xp;
                let newLevel = user.level;
                const nextLevelXp = user.level * 100;

                if (newXp >= nextLevelXp) {
                    newLevel += 1;
                    newXp -= nextLevelXp;
                    playSound(880, 'sine', 0.5);
                }

                const newHistory = { ...user.history, [today]: true };
                setUser({ ...user, level: newLevel, xp: newXp, total: user.total + 1, history: newHistory });
                setSolved(true);
            };

            const isHard = mode === 'hard' || mode === 'daily'; // Dailyもハードな見た目に
            const progress = (user.xp / (user.level * 100)) * 100;

            if (!problem) return null;

            return (
                <div className={`min-h-screen pb-20 transition-colors duration-500 ${isHard ? 'bg-super-hard text-super-hard' : 'bg-slate-50 text-slate-900'}`}>
                    
                    {/* Header */}
                    <header className={`sticky top-0 z-30 border-b backdrop-blur-md ${isHard ? 'bg-black/50 border-red-900/30' : 'bg-white/80 border-slate-200'}`}>
                        <div className="max-w-md mx-auto p-4">
                            <div className="flex justify-between items-end mb-2">
                                <div className="flex items-center gap-2">
                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-black text-white ${isHard ? 'bg-red-800' : 'bg-indigo-600'}`}>
                                        {user.level}
                                    </div>
                                    <span className="text-xs font-bold uppercase tracking-widest opacity-60">Level</span>
                                </div>
                                <span className="text-[10px] font-mono opacity-50">{user.xp} / {user.level * 100} XP</span>
                            </div>
                            <div className="w-full h-1.5 bg-slate-200/20 rounded-full overflow-hidden">
                                <div className={`h-full progress-bar ${isHard ? 'bg-red-600' : 'bg-indigo-500'}`} style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 mt-4 space-y-6">
                        
                        {/* Mode Select */}
                        <div className={`flex p-1 rounded-2xl ${isHard ? 'bg-slate-900 border border-red-900/30' : 'bg-slate-200'}`}>
                            <button onClick={loadDaily} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'daily' ? 'bg-red-900 text-white shadow-lg' : (isHard ? 'text-slate-500' : 'text-slate-500')}`}>今日の問題</button>
                            <button onClick={loadRandom} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'random' ? 'bg-white text-indigo-600 shadow-lg' : 'text-slate-500'}`}>無限演習</button>
                            <button onClick={loadHard} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'hard' ? 'bg-red-800 text-white shadow-lg' : 'text-slate-500'}`}>難問モード</button>
                        </div>

                        {/* Problem Card */}
                        <div className={`rounded-[2.5rem] shadow-2xl border p-8 relative flex flex-col items-center min-h-[400px] justify-center transition-all ${isHard ? 'bg-slate-900 border-red-900/50 shadow-red-900/20' : 'bg-white border-slate-200'}`}>
                            
                            <div className="absolute top-6 left-6">
                                <span className={`text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest ${isHard ? 'bg-red-900/50 text-red-400' : 'bg-slate-100 text-slate-500'}`}>
                                    {problem.type} • +{problem.xp} XP
                                </span>
                            </div>

                            <div className="w-full overflow-x-auto py-10">
                                <MathDisplay latex={problem.latex} />
                            </div>

                            {showHint && (
                                <div className={`w-full p-4 rounded-2xl mb-6 text-sm animate-in slide-in-from-top-4 ${isHard ? 'bg-red-950 border border-red-900/50 text-red-200' : 'bg-yellow-50 text-yellow-900 border border-yellow-100'}`}>
                                    <div className="flex gap-2 mb-1">
                                        <i data-lucide="lightbulb" className="w-4 h-4"></i>
                                        <span className="font-bold uppercase text-[10px]">Hint</span>
                                    </div>
                                    <ParsedText text={problem.hint} />
                                </div>
                            )}

                            {showAnswer && (
                                <div className={`w-full p-6 rounded-2xl mb-8 border animate-in zoom-in-95 ${isHard ? 'bg-black border-red-900/50' : 'bg-indigo-50 border-indigo-100'}`}>
                                    <p className="text-[10px] font-bold opacity-50 uppercase text-center mb-4 tracking-widest">解答</p>
                                    <MathDisplay latex={problem.answer} />
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-3 w-full">
                                <button onClick={() => { setShowHint(!showHint); playSound(440, 'sine', 0.05); }} className={`p-4 rounded-2xl text-xs font-bold transition-all ${isHard ? 'bg-slate-800 text-red-400 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                    ヒント
                                </button>
                                <button onClick={() => { setShowAnswer(!showAnswer); playSound(523, 'sine', 0.05); }} className={`p-4 rounded-2xl text-xs font-bold transition-all ${showAnswer ? (isHard ? 'bg-red-900' : 'bg-slate-800') : (isHard ? 'bg-red-600' : 'bg-indigo-600')} text-white shadow-lg`}>
                                    {showAnswer ? '閉じる' : '答えを見る'}
                                </button>
                            </div>

                            {showAnswer && !solved && (
                                <button onClick={onSolve} className={`w-full mt-4 p-5 rounded-2xl font-black text-lg shadow-xl animate-bounce transition-all ${isHard ? 'bg-gradient-to-r from-red-700 to-red-600 text-white shadow-red-900/50' : 'bg-emerald-500 text-white'}`}>
                                    完答した！
                                </button>
                            )}

                            {solved && (mode !== 'daily') && (
                                <button onClick={mode === 'hard' ? loadHard : loadRandom} className="w-full mt-4 p-5 bg-slate-800 text-white rounded-2xl font-bold">
                                    次の問題へ
                                </button>
                            )}
                        </div>

                        {/* Stamp Collection */}
                        <div className={`p-6 rounded-3xl border ${isHard ? 'bg-slate-900 border-red-900/30' : 'bg-white border-slate-200'}`}>
                            <h2 className="font-bold text-sm mb-4 flex items-center gap-2">
                                <i data-lucide="check-circle" className={`w-4 h-4 ${isHard ? 'text-red-500' : 'text-emerald-500'}`}></i> 今週の記録
                            </h2>
                            <div className="flex justify-between">
                                {[...Array(7)].map((_, i) => {
                                    const date = new Date();
                                    date.setDate(date.getDate() - (6 - i));
                                    const dStr = date.toISOString().slice(0, 10);
                                    const isDone = user.history[dStr];
                                    return (
                                        <div key={i} className="flex flex-col items-center gap-1">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${isDone ? (isHard ? 'bg-red-600 border-red-500 text-white stamp-anim' : 'bg-emerald-500 border-emerald-400 text-white stamp-anim') : 'bg-transparent border-slate-200/20'}`}>
                                                {isDone ? <i data-lucide="check" className="w-5 h-5"></i> : <span className="text-[10px] opacity-20">{date.getDate()}</span>}
                                            </div>
                                            <span className="text-[8px] font-bold opacity-30">{(['日','月','火','水','木','金','土'])[date.getDay()]}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                    </main>

                    <footer className="mt-8 text-center px-8 text-[10px] leading-relaxed opacity-50">
                        <p>© 2026 Integral Master v5.0 - Ultimate Edition</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 200);
    </script>
</body>
</html>